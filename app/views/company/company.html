<div ng-controller="company" class="company container-fluid table-responsive-vertical">
    <div class="row header-view">
        <div class="col-md-12">
            <div class="input-group col-md-5">
                <input type="text" ng-model="queryParams.queryName" class="form-control input-company-search" search-keyword="" placeholder="根据客户{{queryTypeName}}查询" ng-keyup="companyKeyup($event)" />
                <div class="input-group-btn">
                    <button class="btn  btn-default dropdown-toggle search-btn" ng-click="searchCompany()">查询</button>
                    <drop-down btn-style="btn btn-default dropdown-toggle querytype-btn" list={{queryCompanyTypeConfig.nameTypeData}} default-item="{{queryCompanyTypeConfig.nameTypeData[0]}}" select="queryCompanyTypeConfig.selectItem(item)">
                    </drop-down>
                </div>
            </div>
            <button class="btn btn-primary btn-addcompany col-md-1 col-md-offset-4" ng-click="openCreateEditCompanyWin()">添加企业</button>
            <button class="btn btn-default btn-export-excel col-md-1" ng-click="exportCompanyTableExcel()">导出Excel</button>
        </div>
    </div>
    <table ng-table="companyTable" class="table table-condensed table-bordered table-hover ngtable  company-table table-mini">
        <thead>
            <th>序号</th>
            <th>选择</th>
            <th>创建时间</th>
            <th>客户编码</th>
            <th>客户名称</th>
            <th>货架类型</th>
            <th>
                <drop-down list={{customerType.getList(1)}} default-item={{customerType.getDefaultItem(1)}} prevent-auto-selected=true desc-field="name" btn-style="btn-link" select="customerType.selectItem(1,item)">
                </drop-down>
            </th>
            <th>
                <drop-down list={{customerStatus.getList(1)}} default-item={{customerStatus.getDefaultItem(1)}} prevent-auto-selected=true desc-field="name" btn-style="btn-link" select="customerStatus.selectItem(1,item)">
                </drop-down>
            </th>
            <th>联系人</th>
            <th>联系电话</th>
            <th>座机</th>
            <th>送货地址</th>
            <th>跟进人</th>
            <th>操作</th>
        </thead>
        <tr ng-repeat="company in $data">
            <td>{{company.index+1}}</td>
            <td>
                <input type="checkbox" id="checkbox_{{company.companyId}}" class="chk_1" ng-click="updateSelection($event,company)" />
                <label for="checkbox_{{company.companyId}}"></label>
            </td>
            <td>{{company.createTime|date:'yyyy.MM.dd'}}</td>
            <td>{{company.companyId}}</td>
            <td>{{company.companyName}}</td>
            <td>{{company.shelfTypeAlias}}</td>
            <td>{{CONSTANTS.CUSTOMER_TYPE.DESC[company.customerType]}}</td>
            <td>{{CONSTANTS.CUSTOMER_STATUS.DESC[company.status]}}</td>
            <td>{{company.lastContact.contactName}}</td>
            <td>{{company.lastContact.mobile}}</td>
            <td>{{company.lastContact.tel}}</td>
            <td>{{company.address}}</td>
            <td>{{company.followPeople}}</td>
            <td>
                <button class="btn btn-default btn-sm" href="javascript:;" ng-click="openCreateEditCompanyWin(company.companyId)"><span class="glyphicon glyphicon-pencil"></span>
                </button>
            </td>
        </tr>
    </table>
    <div id="exportExcelWrap" hidden></div>
    <dialog title="企业状态变更日志" instance="companyChangeLogCtrl">
        <table ng-table-dynamic="companyChangeLogTable with companyChangeLogTableHeads" class="table table-striped table-mini table-bordered welfare-detail-table">
            <tr ng-repeat="x in $data" ng-init="index = $index">
                <td ng-repeat="y in $columns" ng-class="{{x[y.field].cls}}" compile-html="y.getValue&&y.getValue(x[y.field],x,index,this,y)||x[y.field]">
                </td>
            </tr>
        </table>
    </dialog>
    <dialog title="企业坏账抵扣余额流水记录" instance="companyDeductionCtrl">
        <table ng-table-dynamic="companyDeductionTable with companyDeductionTableHeads" class="table table-striped table-mini table-bordered welfare-detail-table">
            <tr ng-repeat="x in $data" ng-init="index = $index">
                <td ng-repeat="y in $columns" ng-class="{{x[y.field].cls}}" compile-html="y.getValue&&y.getValue(x[y.field],x,index,this,y)||x[y.field]">
                </td>
            </tr>
        </table>
    </dialog>
    <script type="text/ng-template" id="modelcontent">
        <div class="modal-header">
            <button type="button" class="close" ng-click="cancel()"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">{{company.companyId?'修改客户':'添加客户'}}</h4>
        </div>
        <form class="modal-body company-add-modal" name="companyform" novalidate>
            <div class="row {{companyform.companyName.$invalid&&companyform.companyName.$dirty?'has-error':''}}">
                <label class="control-label col-sm-4">客户名称<i class="icon-required">*</i></label>
                <div class="col-sm-12">
                    <input type="text" class="form-control" placeholder="请输入名称" name="companyName" ng-model="company.companyName" required />
                </div>
            </div>
            <div class="row">
                <label class="control-label col-sm-4">客户描述</label>
                <div class="col-sm-12">
                    <input type="text" class="form-control col-sm-6" name="des" placeholder="请输入描述" ng-model="company.des" />
                </div>
            </div>
            <div class="row">
                <label class="control-label col-sm-2">拣货类型</label>
                <div class="form-group col-sm-12">
                    <label>
                        <input type="radio" name="pickingType" ng-value="CONSTANTS.PICKING_TYPE.RANDOM" ng-model="company.pickingType"> 小二可随机配
                    </label>
                    <label>
                        <input type="radio" name="pickingType" ng-value="CONSTANTS.PICKING_TYPE.SELF" ng-model="company.pickingType"> 完全自选
                    </label>
                    <label>
                        <input type="radio" name="pickingType" ng-value="CONSTANTS.PICKING_TYPE.OTHER" ng-model="company.pickingType"> 其他
                    </label>
                    <label class="{{companyform.pickingRemark.$invalid&&companyform.pickingRemark.$dirty?'has-error':''}}">
                        <input type="text" ng-disabled="company.pickingType!=CONSTANTS.PICKING_TYPE.OTHER" class="form-control input-picking-remark" placeholder="请输入类型描述(限20字)" name="pickingRemark" ng-model="company.pickingRemark" ng-maxlength="20" uib-tooltip="限20字" tooltip-placement="top" tooltip-enable="companyform.pickingRemark.$invalid" />
                    </label>
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-6 ">
                    <label>客户地址<i class="icon-required">*</i></label>
                    <input type="text" ng-model="company.address" name="address" required required-input class="form-control" placeholder="请输入地址" />
                </div>
                <div class="form-group col-sm-6 {{companyform.limitFee.$invalid&&companyform.limitFee.$dirty?'has-error':''}}">
                    <label>每月折扣上限设置</label>
                    <input type="text" name="limitFee" ng-model="company.limitFee" placeholder="请输数字" class="form-control" ng-pattern="/^\d+(\.\d{1,2})?$/" uib-tooltip="请输数字" tooltip-placement="top" tooltip-enable="companyform.limitFee.$invalid" />
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-6 {{companyform.staffNum.$invalid&&companyform.staffNum.$dirty?'has-error':''}}">
                    <label>员工数<i class="icon-required">*</i></label>
                    <input name="staffNum" type="text" class="form-control" placeholder="请输数字" ng-model="company.staffNum" required />
                </div>
                <div class="form-group col-sm-6 {{companyform.followPeople.$invalid&&companyform.followPeople.$dirty?'has-error':''}}">
                    <label>公司跟进人<i class="icon-required">*</i></label>
                    <input name="followPeople" type="text" class="form-control" placeholder="请输姓名" ng-model="company.followPeople" required />
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-6 {{companyform.lng.$invalid&&companyform.lng.$dirty?'has-error':''}}">
                    <label>经度<i class="icon-required">*</i></label>
                    <input type="text" name="lng" ng-required="company.lng?false:true" class="form-control" placeholder="请输数字" ng-model="company.lng" ng-pattern="/^[+-]?([0-9]*\.?[0-9]+|[0-9]+\.?[0-9]*)([eE][+-]?[0-9]+)?$/" uib-tooltip="请输入正确格式的数字" tooltip-placement="top" tooltip-enable="companyform.lng.$invalid" />
                </div>
                <div class="form-group col-sm-6 {{companyform.lat.$invalid&&companyform.lat.$dirty?'has-error':''}}">
                    <label>纬度<i class="icon-required">*</i></label>
                    <input type="text" name="lat" ng-required="company.lat?false:true" class="form-control" placeholder="请输数字" ng-model="company.lat" ng-pattern="/^[+-]?([0-9]*\.?[0-9]+|[0-9]+\.?[0-9]*)([eE][+-]?[0-9]+)?$/" uib-tooltip="请输入正确格式的数字" tooltip-placement="top" tooltip-enable="companyform.lat.$invalid" />
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-12">
                    <label class="control-label">送货星期</label>
                    <drop-down btn-style="btn btn-default dropdown-toggle querytype-btn" list={{weekConfig.choices}} default-item="{{weekConfig.defaultItem}}" ng-model="weekConfig" select="weekConfig.selectItem(item)">
                    </drop-down>
                    <md-chips ng-model="company.sendWeek" md-on-remove="weekConfig.delWeek($chip)">
                        <md-chip-template>
                            <span>
                                <strong>{{$chip | desc:'WEEK_TYPE'}}</strong>
                            </span>
                        </md-chip-template>
                    </md-chips>
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-6 {{companyform.superAdmin.$invalid&&companyform.superAdmin.$dirty?'has-error':''}}">
                    <label>超级管理员<i class="icon-required">*</i></label>
                    <input type="text" name="superAdmin" class="form-control" placeholder="请输入超级管理员手机号" ng-model="company.superAdmin" ng-pattern="/^1[3|4|5|7|8][0-9]{9}$/" ng-required="!company.userName" />
                </div>
            </div>
            <div class="row" ng-if="!company.companyId==''">
                <div class="form-group col-sm-7" ng-if="company.userName">
                    <label class="control-label">企业账号</label>
                    <div class="input-group col-md-8">
                        <input type="text" ng-model="company.userName" class="form-control input-company-search" search-keyword="" placeholder="" disabled />
                        <div class="input-group-btn">
                            <button class="btn btn-default dropdown-toggle" ng-click="resetPWD()">
                                重置密码
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group col-sm-5" ng-if="!company.companyId==''">
                    <label class="control-label">企业是否溢价</label>
                    <div class="input-group col-md-6">
                        <md-switch class="md-primary" md-no-ink aria-label="Switch No Ink" ng-change="changeCompanyPremiumState(company)" ng-model="company.isPremium"></md-switch>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-6">
                    <label class="control-label">货架类型</label>
                    <div class="btn-group">
                        <drop-down btn-style="btn-default" required list={{formConfig.getList()}} default-item="{{formConfig.getDefaultItem(company.shelfType)}}" ng-model="company.shelfType" select="formConfig.selectItem(item)">
                        </drop-down>
                    </div>
                </div>
                <div class="form-group col-sm-6">
                    <label class="control-label">客户状态</label>
                    <div class="btn-group">
                        <drop-down btn-style="btn-default" required list={{customerStatus.getList(2)}} default-item="{{customerStatus.getDefaultItem(2,company.status)}}" ng-model="company.status" select="customerStatus.selectItem(2,item)" desc-field="name">
                        </drop-down>
                        <button class="btn btn-default changlog-btn" ng-click="getCompanyStateChangeLog(company.companyId)" ng-if="!company.companyId==''"><span class="glyphicon glyphicon-align-justify"></span></button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-6">
                    <label class="control-label">客户类别</label>
                    <div class="btn-group">
                        <drop-down btn-style="btn-default" required list={{customerType.getList(2)}} default-item="{{customerType.getDefaultItem(2,company.customerType)}}" ng-model="company.customerType" desc-field="name" select="customerType.selectItem(2,item)">
                        </drop-down>
                    </div>
                </div>
            </div>
            <div class="row" ng-if='company.companyId'>
                <div class="form-group col-sm-6">
                    <label class="control-label">黑名单</label>
                    <div class="btn-group" ng-click="seeBlock(company.companyId)">
                        点击查看
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-12 {{companyform.change.$invalid&&companyform.change.$dirty?'has-error':''}}">
                    <label class="control-label">企业坏账抵扣额</label>
                    <div class="btn-group">
                        <input type="text" ng-disabled="!company.companyId==''" name="change" ng-model="company.change" placeholder="请输数字" class="form-control" ng-pattern="/^\d+(\.\d{1,2})?$/" uib-tooltip="请输数字" tooltip-placement="top" tooltip-enable="companyform.change.$invalid" />
                    </div>
                    <button class="btn btn-default changlog-btn" ng-click="getCompanyDeductionList(company.companyId)" ng-if="!company.companyId==''"><span class="glyphicon glyphicon-align-justify"></span></button>
                    <span class="label label-default" ng-if="!company.companyId==''">¥{{company.balance|rmb}}</span>
                </div>
            </div>
            <div class="form-group">
                <label>联系方式</label>
                <button class="btn btn-default" ng-click="confirmAdd()">
                    <span class="glyphicon glyphicon-plus"></span>
                </button>
            </div>
            <table ng-table-dynamic="contactTable with contactHeads" class="table table-striped table-bordered contact-table">
                <tr ng-repeat="x in $data" ng-form="rowForm" ng-init="index = $index">
                    <td ng-repeat="y in $columns" ng-class="rowForm[y.field].$dirty ? 'bg-warning' : ''" ng-form="{{y.field}}">
                        <span ng-if="y.dataType !== 'command' && !x.isEditing" class="editable-text">{{x[y.field]}}</span>
                        <div ng-if="y.dataType !== 'command' && x.isEditing" class="controls" ng-class="rowForm[y.field].$invalid && rowForm[y.field].$dirty ? 'has-error' : ''" ng-switch="y.dataType">
                            <input ng-switch-default type="text" name="{{y.field}}" ng-model="x[y.field]" class="editable-input form-control input-sm" ng-required="y.relatedField?!x[y.relatedField]:(y.required?y.field:'')" />
                            <input ng-switch-when="number" type="number" name="{{y.field}}" ng-model="x[y.field]" class="editable-input form-control input-sm" ng-required="y.relatedField?x[y.relatedField]:(y.required?y.field:'')" />
                        </div>
                        <div class="edit-col" ng-if="y.dataType === 'command'">
                            <button class="btn btn-primary btn-sm" ng-click="confirmEdit(x, rowForm,this)" ng-if="x.isEditing" ng-disabled="rowForm.$pristine || rowForm.$invalid"><span class="glyphicon glyphicon-ok"></span></button>
                            <button class="btn btn-default btn-sm" ng-click="cancelEdit(x,rowForm)" ng-if="x.isEditing"><span class="glyphicon glyphicon-remove"></span></button>
                            <button class="btn btn-default btn-sm" ng-click="startEdit(x,rowForm)" ng-if="!x.isEditing"><span class="glyphicon glyphicon-pencil"></span></button>
                            <button class="btn btn-danger btn-sm" ng-click="confirmDelete(x)" ng-if="!x.isEditing"><span class="glyphicon glyphicon-trash"></span></button>
                        </div>
                    </td>
                </tr>
            </table>
            <div class="modal-footer modal-footer-edit">
                <button type="button" class="btn btn-default" data-dismiss="modal" ng-click="cancel()">取消</button>
                <button type="submit" class="btn btn-primary btn-editcompany-ensure" ng-disabled="companyform.$invalid" ng-click="submitCompanyConfirm(company)">确定</button>
            </div>
        </form>
    </script>
    <script type="text/ng-template" id="blockManage">
        <div class="modal-header">
            <button type="button" class="close" ng-click="cancel()"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">黑名单管理</h4>
        </div>
        <div class="zeroBlock userDefined">
            <h4>零促销商品</h4>
            <div class="blockList ">
                <table class="table table-condensed table-bordered table-hover ngtable  block-table table-mini" ng-if="blockZeroProduct.length>0">
                    <tr ng-repeat="li in blockZeroProduct">
                        <td>{{li.createdTime|date:'yyyy-MM-dd HH:mm:ss'}}</td>
                        <td>{{li.productName}}</td>
                        <td>{{li.sellA==0||li.sellN==0?"最近一次零动销":"历史零动销"}}</td>
                    </tr>
                </table>
                <p ng-if="blockZeroProduct.length==0">暂时没有零促销商品</p>
            </div>
            <div class="userDefined">
                <h4>自定义</h4>
                <div class="addBar">
                    <div block-add add-block='addBlock(productId,reason,callback)' class="addBlock">
                    </div>
                </div>
                <div class="blockBody" ng-if="blockConpanyList.length>0">
                    <table class="table table-condensed table-bordered table-hover ngtable  block-table table-mini" ng-if="blockConpanyList.length>0">
                        <tr ng-repeat="item in blockConpanyList">
                            <td>{{item.createTime|date:'yyyy-MM-dd HH:mm:ss'}}</td>
                            <td>{{item.productName}}</td>
                            <td>{{item.reason}}</td>
                            <td>{{item.operatorName}}</td>
                            <td>
                                <button class="btn btn-default btn-sm" href="javascript:;" ng-click="modifyBlock(item.id,item.productName,item.reason)"><span class="glyphicon glyphicon-pencil"></span>
                                </button>
                                <button class="btn btn-danger btn-sm" ng-click="deleteBlock(item.id)" ng-if="!x.isEditing"><span class="glyphicon glyphicon-trash"></span></button>
                            </td>
                        </tr>
                    </table>
                </div>
                <p ng-if="blockConpanyList.length==0">暂时没有黑名单商品</p>
            </div>
        </div>
    </script>
    <!--  <script title={{block.name}} type="text/ng-template" panel instance="modifyDialog">
        <form name="modifyForm" novalidate style="width:300px;">
            <div class="row" >
            <textarea name="" id="" style="width: 90%;margin: 0 auto;display:block;" rows="2" ng-model='block.modifyReason' placeholder='请输入原因'></textarea>    
            </div>
        </form>
        <div layout="row" class="demo-dialog-button">
            <md-button md-autofocus flex class="md-raised md-primary "  ng-click="modifyBlockSure()">
                确定
            </md-button>
        </div>
    </script> -->
    <script type="text/ng-template" id="modifyDialog">
        <div class="modal-header">
            <h4 class="modal-title">请修改黑名单理由</h4>
            <button style="position: absolute;top: 5px;right: 8px;color: red;" type="button" class="close" ng-click="cancel()"><span aria-hidden="true">&times;</span></button>
        </div>
        <form class="modal-body" name="deleteForm" novalidate ng-submit="modifyBlockSure()">
            <!--novalidate-->
            <textarea name="" id="" style="width: 90%;margin: 0 auto;display:block;" rows="2" ng-model='block.modifyReason' placeholder='请输入原因'></textarea>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" ng-click="cancel()">取消</button>
                <button type="submit" class="btn btn-primary">确认</button>
            </div>
        </form>
    </script>
    <script type="text/ng-template" id="blockDelete">
        <div class="modal-header">
            <h4 class="modal-title">删除黑名单商品</h4>
            <button style="position: absolute;top: 5px;right: 8px;color: red;" type="button" class="close" ng-click="cancel()"><span aria-hidden="true">&times;</span></button>
        </div>
        <form class="modal-body" name="deleteForm" novalidate ng-submit="deleteCancel()">
            <!--novalidate-->
            <input type="hidden" ng-model="deleteForm.productId" />
            <span style="font-family: Microsoft YaHei;font-size: 15px;">您确定要在黑名单中删除这条商品吗?</span>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" ng-click="cancel()">取消</button>
                <button type="submit" class="btn btn-primary">确认</button>
            </div>
        </form>
    </script>
</div>